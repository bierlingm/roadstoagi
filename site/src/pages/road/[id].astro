---
import Base from "../../layouts/Base.astro";
import RoadHeader from "../../components/RoadHeader.astro";
import ClaimCard from "../../components/ClaimCard.astro";
import SharePack from "../../components/SharePack.astro";
import { loadRoads, loadClaims, loadGates, getClaimById, getGateById } from "../../lib/loaders.js";

export function getStaticPaths() {
  const roads = loadRoads();
  return roads.map(road => ({ params: { id: road.id } }));
}

const { id } = Astro.params;
const roads = loadRoads();
const allClaims = loadClaims();
const allGates = loadGates();

const road = roads.find(r => r.id === id);
if (!road) return Astro.redirect("/404");

const claims = (road.includes_claims || []).map(cid => getClaimById(allClaims, cid)).filter(Boolean);
const survivingCount = claims.filter(c => c.status === "surviving").length;
const contestedCount = claims.filter(c => c.status === "contested").length;

// Enrich claims with gate data
const enrichedClaims = claims.map(claim => ({
  ...claim,
  gatesData: (claim.gates || []).map(gid => {
    const gate = getGateById(allGates, gid);
    return {
      id: gid,
      kind: gate?.kind || 'unknown',
      state: claim.status === 'surviving' ? 'pass' : (claim.status === 'contested' ? 'disputed' : 'dormant')
    };
  })
}));
---
<Base title={`${road.title} | Roads to AGI`}>
  <div class="container-wide">
    <nav class="breadcrumb">
      <a href="/roads" class="muted">‚Üê All Roads</a>
    </nav>
    
    <RoadHeader 
      id={road.id}
      title={road.title}
      thesis={road.thesis}
      version={road.version}
      status={road.status}
      claimsCount={claims.length}
      survivingCount={survivingCount}
      contestedCount={contestedCount}
    />

    <section class="claims-section stack">
      <h2>Claims</h2>
      {enrichedClaims.map(claim => (
        <ClaimCard 
          id={claim.id}
          text={claim.text}
          status={claim.status}
          gates={claim.gatesData}
          version={claim.version}
        />
      ))}
      {claims.length === 0 && (
        <p class="muted">No claims in this road yet.</p>
      )}
    </section>

    <hr class="rule" />
    
    <section class="actions-section cluster">
      <a href={`/challenges`} class="btn">Challenge a Claim</a>
      <a href="/submit" class="btn">Submit Your Road</a>
    </section>

    <SharePack 
      title={road.title}
      description={road.thesis}
      url={`https://roadstoagi.org/road/${road.id}`}
      claims={claims.slice(0, 3).map(c => c.text.slice(0, 100) + (c.text.length > 100 ? '...' : ''))}
    />
  </div>
</Base>

<style>
  .breadcrumb {
    margin-bottom: var(--space-6);
  }

  .claims-section {
    margin: var(--space-8) 0;
  }

  .claims-section h2 {
    margin-bottom: var(--space-6);
  }

  .actions-section {
    margin: var(--space-8) 0;
  }
</style>
